name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Test Docker build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: vapor-app:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Verify build success
      run: echo "âœ… Docker build completed successfully"

    # Supabase migrations are now managed manually or via a separate workflow.

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    env:
      PROJECT_ID: sparatfinalproject
      REGION: europe-west1
      SERVICE_NAME: finalprojectsever
      IMAGE_NAME: vapordockerapp

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Set up gcloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker auth for GCR
      run: gcloud auth configure-docker gcr.io --quiet

    - name: Build and push image to GCR
      env:
        IMAGE_SHA: gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        IMAGE_LATEST: gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE_NAME }}:latest
      run: |
        docker build --platform=linux/amd64 -t "$IMAGE_SHA" .
        docker push "$IMAGE_SHA"
        docker tag "$IMAGE_SHA" "$IMAGE_LATEST"
        docker push "$IMAGE_LATEST"

    - name: Generate Cloud Run env file
      run: |
        cat <<EOF > env.yaml
        SUPABASE_DB_URL: "${SUPABASE_DB_URL}"
        SUPERBASE_DB_URL: "${SUPERBASE_DB_URL}"
        DATABASE_URL: "${DATABASE_URL}"
        JWT_SECRET: "${JWT_SECRET}"
        SUPERBASE_URL: "${SUPERBASE_URL}"
        SUPERBASE_ANON_KEY: "${SUPERBASE_ANON_KEY}"
        SUPERBASE_PROFILE_TABLE: "${SUPERBASE_PROFILE_TABLE}"
        EOF
      env:
        SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        SUPERBASE_DB_URL: ${{ secrets.SUPERBASE_DB_URL }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        SUPERBASE_URL: ${{ secrets.SUPERBASE_URL }}
        SUPERBASE_ANON_KEY: ${{ secrets.SUPERBASE_ANON_KEY }}
        SUPERBASE_PROFILE_TABLE: ${{ secrets.SUPERBASE_PROFILE_TABLE }}

    - name: Deploy to Cloud Run
      env:
        IMAGE_SHA: gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        SERVICE_NAME: ${{ env.SERVICE_NAME }}
        PROJECT_ID: ${{ env.PROJECT_ID }}
        REGION: ${{ env.REGION }}
      run: |
        gcloud run deploy "$SERVICE_NAME" \
          --image "$IMAGE_SHA" \
          --project "$PROJECT_ID" \
          --region "$REGION" \
          --platform managed \
          --allow-unauthenticated \
          --env-vars-file=env.yaml

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-test

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
