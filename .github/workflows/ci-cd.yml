name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  build-test-migrate:
    name: Build, Test & Migrate
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Test Docker build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: vapor-app:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Verify build success
      run: echo "âœ… Docker build completed successfully"

    - name: Cache Swift build artifacts
      uses: actions/cache@v3
      with:
        path: |
          .build
          .swiftpm
        key: swiftpm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}

    - name: Install Swift 6 toolchain
      env:
        SWIFT_VERSION: swift-6.0.1-RELEASE
        SWIFT_PLATFORM: ubuntu22.04
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          libsqlite3-dev \
          libncurses5-dev \
          libcurl4 \
          libatomic1 \
          libxml2 \
          tzdata \
          zip \
          unzip
        SWIFT_TAR="${SWIFT_VERSION}-${SWIFT_PLATFORM}.tar.gz"
        SWIFT_URL="https://download.swift.org/swift-6.0.1-release/${SWIFT_PLATFORM}/${SWIFT_VERSION}/${SWIFT_TAR}"
        curl -fL "$SWIFT_URL" -o swift.tar.gz
        tar -xzf swift.tar.gz
        sudo mv ${SWIFT_VERSION}-${SWIFT_PLATFORM} /opt/${SWIFT_VERSION}
        echo "/opt/${SWIFT_VERSION}/usr/bin" >> $GITHUB_PATH
        rm swift.tar.gz

    - name: Run Fluent migrations against Supabase
      env:
        SUPERBASE_DB_URL: ${{ secrets.SUPERBASE_DB_URL }}
        SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        if [ -z "${SUPERBASE_DB_URL}${SUPABASE_DB_URL}${DATABASE_URL}" ]; then
          echo "Database URL secret is missing. Please set SUPERBASE_DB_URL or SUPABASE_DB_URL or DATABASE_URL." >&2
          exit 1
        fi
        swift build --product VaporDockerApp
        swift run --skip-build VaporDockerApp migrate --yes

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: build-test-migrate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Deploy to Render
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-test-migrate

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
